From 853e5653cb8326edc17627e37ef0cc6a91a3ec09 Mon Sep 17 00:00:00 2001
From: Niyas Sait <niyas.sait@linaro.org>
Date: Mon, 24 Jan 2022 09:44:20 +0000
Subject: [PATCH 1/1] add win/arm64 clang configurations

---
 BUILD.bazel            | 14 ++++++++++++++
 build_defs.bzl         |  9 +++++++++
 src/xnnpack/assembly.h |  7 +++++++
 3 files changed, 30 insertions(+)

diff --git a/BUILD.bazel b/BUILD.bazel
index 1d48ba6ee..630834d9a 100644
--- a/BUILD.bazel
+++ b/BUILD.bazel
@@ -11929,6 +11929,20 @@ config_setting(
     },
 )
 
+
+config_setting(
+    name = "windows_arm64",
+    values = {"cpu": "x64_arm64_windows"},
+)
+
+config_setting(
+    name = "windows_arm64_clang",
+    values = {
+        "compiler": "clang-cl",
+        "cpu": "x64_arm64_windows",
+    },
+)
+
 config_setting(
     name = "windows_x86_64_mingw",
     values = {
diff --git a/build_defs.bzl b/build_defs.bzl
index fbadb4007..2b4281559 100644
--- a/build_defs.bzl
+++ b/build_defs.bzl
@@ -157,6 +157,8 @@ def xnnpack_cc_library(
             ":windows_x86_64_mingw": x86_srcs,
             ":windows_x86_64_msys": x86_srcs,
             ":windows_x86_64": x86_srcs,
+            ":windows_arm64": aarch64_srcs,
+            ":windows_arm64_clang": aarch64_srcs,
             ":android_armv7": aarch32_srcs,
             ":android_arm64": aarch64_srcs,
             ":android_x86": x86_srcs,
@@ -193,6 +195,7 @@ def xnnpack_cc_library(
             ":windows_x86_64_mingw": mingw_copts + gcc_x86_copts,
             ":windows_x86_64_msys": msys_copts + gcc_x86_copts,
             ":windows_x86_64": msvc_x86_64_copts,
+            ":windows_arm64": aarch64_copts,
             ":android_armv7": aarch32_copts,
             ":android_arm64": aarch64_copts,
             ":android_x86": gcc_x86_copts,
@@ -217,6 +220,7 @@ def xnnpack_cc_library(
             ":windows_x86_64_mingw": gcc_copts,
             ":windows_x86_64_msys": gcc_copts,
             ":windows_x86_64": msvc_copts,
+            ":windows_arm64": ["/clang:" + opt for opt in gcc_copts],
             "//conditions:default": gcc_copts,
         }) + select({
             ":optimized_build": optimized_copts,
@@ -283,6 +287,7 @@ def xnnpack_aggregate_library(
             ":windows_x86_64_mingw": x86_deps,
             ":windows_x86_64_msys": x86_deps,
             ":windows_x86_64": x86_deps,
+            ":windows_arm64": aarch64_deps,
             ":android_armv7": aarch32_nonios_deps,
             ":android_arm64": aarch64_deps,
             ":android_x86": x86_deps,
@@ -340,6 +345,7 @@ def xnnpack_unit_test(name, srcs, copts = [], mingw_copts = [], msys_copts = [],
                 ":windows_x86_64_mingw": ["-Wno-unused-function"],
                 ":windows_x86_64_msys": ["-Wno-unused-function"],
                 ":windows_x86_64": [],
+                ":windows_arm64": [],
                 "//conditions:default": ["-Wno-unused-function"],
             }) + copts,
             linkopts = select({
@@ -373,6 +379,7 @@ def xnnpack_unit_test(name, srcs, copts = [], mingw_copts = [], msys_copts = [],
                 ":windows_x86_64_mingw": ["-Wno-unused-function"],
                 ":windows_x86_64_msys": ["-Wno-unused-function"],
                 ":windows_x86_64": [],
+                ":windows_arm64": [],
                 "//conditions:default": ["-Wno-unused-function"],
             }) + copts,
             linkopts = select({
@@ -440,12 +447,14 @@ def xnnpack_benchmark(name, srcs, copts = [], deps = [], tags = []):
             ":windows_x86_64_mingw": ["-Wno-unused-function"],
             ":windows_x86_64_msys": ["-Wno-unused-function"],
             ":windows_x86_64": [],
+            ":windows_arm64": [],
             "//conditions:default": ["-Wno-unused-function"],
         }) + copts,
         linkopts = select({
             ":emscripten": xnnpack_emscripten_benchmark_linkopts(),
             ":windows_x86_64_mingw": ["-lshlwapi"],
             ":windows_x86_64_msys": ["-lshlwapi"],
+            ":windows_arm64": [],
             "//conditions:default": [],
         }),
         linkstatic = True,
diff --git a/src/xnnpack/assembly.h b/src/xnnpack/assembly.h
index cb329228d..64c8dacf1 100644
--- a/src/xnnpack/assembly.h
+++ b/src/xnnpack/assembly.h
@@ -39,6 +39,13 @@
     .private_extern _\name
     _\name:
   .endm
+#elif defined(__clang__) && defined(_M_ARM64)
+  .macro BEGIN_FUNCTION name
+    .text
+    .p2align 4
+    .global \name
+    \name:
+  .endm
 
   .macro END_FUNCTION name
   .endm
-- 
2.34.1

