From cc78f88f6164557856b837fc9bb7db56cc36ddf7 Mon Sep 17 00:00:00 2001
From: Niyas Sait <niyas.sait@linaro.org>
Date: Mon, 24 Jan 2022 09:58:54 +0000
Subject: [PATCH 1/1] add win_arm64 config

---
 BUILD | 28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)

diff --git a/BUILD b/BUILD
index 8b99116..846a19c 100644
--- a/BUILD
+++ b/BUILD
@@ -91,6 +91,11 @@ config_setting(
     values = {"cpu": "x64_windows"},
 )
 
+config_setting(
+    name = "msvc_windows_arm64",
+    values = {"cpu": "x64_arm64_windows"},
+)
+
 config_setting(
     name = "freebsd",
     values = {"cpu": "freebsd"},
@@ -126,6 +131,7 @@ NSYNC_OPTS_GENERIC = select({
     ":android_arm": ["-I" + pkg_path_name() + "/platform/arm"],
     ":android_arm64": ["-I" + pkg_path_name() + "/platform/aarch64"],
     ":msvc_windows_x86_64": ["-I" + pkg_path_name() + "/platform/x86_64"],
+    ":msvc_windows_arm64": ["-I" + pkg_path_name() + "/platform/arm"],
     "//conditions:default": [],
 }) + [
     "-I" + pkg_path_name() + "/public",
@@ -134,6 +140,8 @@ NSYNC_OPTS_GENERIC = select({
 ] + select({
     ":msvc_windows_x86_64": [
     ],
+    ":msvc_windows_arm64": [
+    ],
     ":freebsd": ["-pthread"],
     "//conditions:default": [
         "-D_POSIX_C_SOURCE=200809L",
@@ -159,6 +167,7 @@ NSYNC_OPTS = select({
     ":android_arm": ["-I" + pkg_path_name() + "/platform/linux"],
     ":android_arm64": ["-I" + pkg_path_name() + "/platform/linux"],
     ":msvc_windows_x86_64": ["-I" + pkg_path_name() + "/platform/win32"],
+    ":msvc_windows_arm64": ["-I" + pkg_path_name() + "/platform/win32"],
     "//conditions:default": [],
 }) + select({
     # Select the compiler include directory.
@@ -177,6 +186,7 @@ NSYNC_OPTS = select({
     ":android_arm": ["-I" + pkg_path_name() + "/platform/gcc"],
     ":android_arm64": ["-I" + pkg_path_name() + "/platform/gcc"],
     ":msvc_windows_x86_64": ["-I" + pkg_path_name() + "/platform/msvc"],
+    ":msvc_windows_arm64": ["-I" + pkg_path_name() + "/platform/msvc"],
 }) + select({
     # Apple deprecated their atomics library, yet recent versions have no
     # working version of stdatomic.h; so some recent versions need one, and
@@ -191,6 +201,9 @@ NSYNC_OPTS_CPP = select({
     ":msvc_windows_x86_64": [
         "/TP",
     ],
+    ":msvc_windows_arm64": [
+        "/TP",
+    ],
     "//conditions:default": [
         "-x",
         "c++",
@@ -222,18 +235,24 @@ NSYNC_OPTS_CPP = select({
         "-I" + pkg_path_name() + "/platform/win32",
         "-I" + pkg_path_name() + "/platform/msvc",
     ],
+    ":msvc_windows_arm64": [
+        "-I" + pkg_path_name() + "/platform/win32",
+        "-I" + pkg_path_name() + "/platform/msvc",
+    ],
     "//conditions:default": ["-I" + pkg_path_name() + "/platform/gcc"],
 }) + NSYNC_OPTS_GENERIC
 
 # Link options (for tests) built in C (rather than C++11).
 NSYNC_LINK_OPTS = select({
     ":msvc_windows_x86_64": [],
+    ":msvc_windows_arm64": [],
     "//conditions:default": ["-pthread"],
 })
 
 # Link options (for tests) built in C++11 (rather than C).
 NSYNC_LINK_OPTS_CPP = select({
     ":msvc_windows_x86_64": [],
+    ":msvc_windows_arm64": [],
     "//conditions:default": ["-pthread"],
 })
 
@@ -381,6 +400,7 @@ NSYNC_SRC_PLATFORM = select({
     ":android_arm": NSYNC_SRC_ANDROID,
     ":android_arm64": NSYNC_SRC_ANDROID,
     ":msvc_windows_x86_64": NSYNC_SRC_WINDOWS,
+    ":msvc_windows_arm64": NSYNC_SRC_WINDOWS,
 })
 
 # C++11-specific (OS and architecture independent) library source.
@@ -415,6 +435,13 @@ NSYNC_SRC_PLATFORM_CPP = [
         "platform/win32/src/pthread_key_win32.cc",
         "platform/win32/src/per_thread_waiter.c",
     ],
+    ":msvc_windows_arm64": [
+        "platform/win32/src/clock_gettime.c",
+        # Windows has no thread-specific data with thread-exit destructors; we
+        # must emulate it with C++ per-thread class destructors.
+        "platform/win32/src/pthread_key_win32.cc",
+        "platform/win32/src/per_thread_waiter.c",
+    ],
     # It's dangerous to use C++ class destructors if we can avoid it, because
     # nsync may be linked into the address space multiple times.
     "//conditions:default": ["platform/posix/src/per_thread_waiter.c"],
@@ -527,6 +554,7 @@ NSYNC_TEST_SRC_PLATFORM = select({
     ":android_arm": NSYNC_TEST_SRC_ANDROID,
     ":android_arm64": NSYNC_TEST_SRC_ANDROID,
     ":msvc_windows_x86_64": NSYNC_TEST_SRC_WINDOWS,
+    ":msvc_windows_arm64": NSYNC_TEST_SRC_WINDOWS,
 })
 
 # C++11-specific (OS and architecture independent) test library source.
-- 
2.34.1

